/**
 * Script de prueba y documentaci√≥n para APIs de Campos Anidados
 * Prueba todas las funcionalidades de consultas din√°micas para formularios
 * y genera documentaci√≥n autom√°tica de los schemas y uso de las APIs
 */

const axios = require("axios");
const fs = require("fs");

// Configuraci√≥n
const BASE_URL = "http://localhost:3001";
const API_BASE = `${BASE_URL}/api/campos-anidados`;

// Credenciales de usuario admin
const CREDENCIALES_ADMIN = {
  usuario: "admin",
  password: "1234567",
};

// Variable global para almacenar el token
let TOKEN_AUTENTICACION = null;

// Variable para almacenar toda la documentaci√≥n generada
let DOCUMENTACION_GENERADA = {
  fecha: new Date().toISOString(),
  usuario: "admin",
  apis: {},
  schemas: {},
  ejemplos: {},
  estadisticas: {},
};

// Datos de prueba
const FORMULARIOS_PRUEBA = [
  "INVENTARIO",
  "TRAZABILIDAD",
  "RECEPCIONES_LOTES",
  "OPERACIONES_FRIO_DESPACHO",
  "STOCK_UBICACIONES",
  "TARJAS",
];

const CAMPOS_PRUEBA = [
  "materiales",
  "proveedores",
  "ubicaciones",
  "plantas",
  "temporadas",
];

/**
 * Funci√≥n para autenticarse y obtener token
 */
async function autenticarUsuario() {
  console.log("üîê Autenticando usuario admin...");

  try {
    const respuesta = await axios.post(
      `${BASE_URL}/api/auth/login`,
      CREDENCIALES_ADMIN
    );

    if (respuesta.data && respuesta.data.datos && respuesta.data.datos.token) {
      TOKEN_AUTENTICACION = respuesta.data.datos.token;
      console.log("‚úÖ Autenticaci√≥n exitosa");
      return true;
    } else {
      console.log("‚ùå Error: No se recibi√≥ token de autenticaci√≥n");
      return false;
    }
  } catch (error) {
    console.log(
      "‚ùå Error de autenticaci√≥n:",
      error.response?.data?.mensaje || error.message
    );
    return false;
  }
}

/**
 * Funci√≥n para documentar una respuesta de API
 */
function documentarRespuestaAPI(
  endpoint,
  metodo,
  parametros,
  respuesta,
  tiempo
) {
  const clave = `${metodo} ${endpoint}`;

  if (!DOCUMENTACION_GENERADA.apis[clave]) {
    DOCUMENTACION_GENERADA.apis[clave] = {
      endpoint,
      metodo,
      descripcion: "",
      parametros: {},
      respuestas: {},
      ejemplos: [],
      estadisticas: {
        totalLlamadas: 0,
        exitosas: 0,
        fallidas: 0,
        tiempoPromedio: 0,
      },
    };
  }

  const api = DOCUMENTACION_GENERADA.apis[clave];
  api.estadisticas.totalLlamadas++;

  if (respuesta.exito) {
    api.estadisticas.exitosas++;

    // Documentar estructura de respuesta exitosa
    if (respuesta.datos && respuesta.datos.datos) {
      const schema = analizarEstructura(respuesta.datos.datos, clave);
      api.respuestas.exitosa = {
        status: respuesta.status,
        estructura: schema,
        ejemplo: respuesta.datos,
      };
    }
  } else {
    api.estadisticas.fallidas++;
    api.respuestas.error = {
      status: respuesta.status,
      mensaje: respuesta.error,
      ejemplo: respuesta,
    };
  }

  // Documentar par√°metros
  if (parametros) {
    Object.keys(parametros).forEach((param) => {
      api.parametros[param] = {
        tipo: typeof parametros[param],
        ejemplo: parametros[param],
        descripcion: inferirDescripcionParametro(param),
      };
    });
  }

  return api;
}

/**
 * Funci√≥n para analizar estructura de datos
 */
function analizarEstructura(datos, contexto = "") {
  if (Array.isArray(datos)) {
    if (datos.length > 0) {
      return {
        tipo: "array",
        elementos: analizarEstructura(datos[0], contexto),
        cantidad: datos.length,
      };
    }
    return { tipo: "array", elementos: null, cantidad: 0 };
  }

  if (typeof datos === "object" && datos !== null) {
    const estructura = {
      tipo: "object",
      propiedades: {},
    };

    Object.keys(datos).forEach((clave) => {
      estructura.propiedades[clave] = {
        tipo: typeof datos[clave],
        ejemplo: datos[clave],
        obligatorio: datos[clave] !== null && datos[clave] !== undefined,
      };

      if (typeof datos[clave] === "object" && datos[clave] !== null) {
        estructura.propiedades[clave].estructura = analizarEstructura(
          datos[clave],
          `${contexto}.${clave}`
        );
      }
    });

    return estructura;
  }

  return {
    tipo: typeof datos,
    ejemplo: datos,
  };
}

/**
 * Funci√≥n para inferir descripci√≥n de par√°metros
 */
function inferirDescripcionParametro(param) {
  const descripciones = {
    limite: "N√∫mero m√°ximo de resultados a retornar",
    busqueda: "T√©rmino de b√∫squeda para filtrar resultados",
    pagina: "N√∫mero de p√°gina para paginaci√≥n",
    tamanoPagina: "Cantidad de elementos por p√°gina",
    campos: "Lista de campos separados por coma",
    filtros: "Filtros adicionales en formato JSON",
    ordenarPor: "Campo por el cual ordenar los resultados",
    direccion: "Direcci√≥n de ordenamiento (asc/desc)",
  };

  return descripciones[param] || `Par√°metro ${param}`;
}

/**
 * Funci√≥n para hacer request con manejo de errores
 */
async function hacerRequest(metodo, url, datos = null, documentar = true) {
  const tiempoInicio = Date.now();
  const parametros = extraerParametrosDeURL(url);

  try {
    const config = {
      method: metodo,
      url: `${API_BASE}${url}`,
      timeout: 10000,
      headers: {},
    };

    // A√±adir token de autenticaci√≥n si est√° disponible
    if (TOKEN_AUTENTICACION) {
      config.headers["Authorization"] = `Bearer ${TOKEN_AUTENTICACION}`;
    }

    if (datos) {
      config.data = datos;
    }

    const respuesta = await axios(config);
    const resultado = {
      exito: true,
      datos: respuesta.data,
      status: respuesta.status,
      tiempo: Date.now() - tiempoInicio,
    };

    // Documentar autom√°ticamente
    if (documentar) {
      documentarRespuestaAPI(
        url.split("?")[0],
        metodo,
        parametros,
        resultado,
        resultado.tiempo
      );
    }

    return resultado;
  } catch (error) {
    const resultado = {
      exito: false,
      error:
        error.response?.data?.mensaje || error.response?.data || error.message,
      status: error.response?.status || 500,
      detalle: error.response?.data?.detalle || null,
      tiempo: Date.now() - tiempoInicio,
    };

    // Documentar errores tambi√©n
    if (documentar) {
      documentarRespuestaAPI(
        url.split("?")[0],
        metodo,
        parametros,
        resultado,
        resultado.tiempo
      );
    }

    return resultado;
  }
}

/**
 * Funci√≥n para extraer par√°metros de URL
 */
function extraerParametrosDeURL(url) {
  const parametros = {};
  const [, queryString] = url.split("?");

  if (queryString) {
    queryString.split("&").forEach((param) => {
      const [clave, valor] = param.split("=");
      parametros[decodeURIComponent(clave)] = decodeURIComponent(valor || "");
    });
  }

  return parametros;
}

/**
 * Prueba obtener configuraci√≥n de formulario
 */
async function probarConfiguracionFormulario(formulario) {
  console.log(`\nüìã Probando configuraci√≥n para formulario: ${formulario}`);

  const resultado = await hacerRequest("GET", `/${formulario}/configuracion`);

  if (resultado.exito) {
    console.log(`‚úÖ Configuraci√≥n obtenida exitosamente`);
    console.log(
      `   - Campos encontrados: ${
        Object.keys(resultado.datos.datos || {}).length
      }`
    );

    // Mostrar algunos campos
    const campos = Object.keys(resultado.datos.datos || {});
    if (campos.length > 0) {
      console.log(
        `   - Campos: ${campos.slice(0, 3).join(", ")}${
          campos.length > 3 ? "..." : ""
        }`
      );
    }
  } else {
    console.log(`‚ùå Error: ${resultado.error}`);
    if (resultado.detalle) {
      console.log(`   Detalle: ${resultado.detalle}`);
    }
    console.log(`   Status: ${resultado.status}`);
  }

  return resultado;
}

/**
 * Prueba obtener opciones de campo
 */
async function probarOpcionesCampo(formulario, campo) {
  console.log(`\nüîç Probando opciones para ${formulario}/${campo}`);

  const resultado = await hacerRequest(
    "GET",
    `/${formulario}/${campo}/opciones?limite=5`
  );

  if (resultado.exito) {
    console.log(`‚úÖ Opciones obtenidas exitosamente`);
    console.log(`   - Total opciones: ${resultado.datos.datos?.length || 0}`);

    // Mostrar algunas opciones
    const opciones = resultado.datos.datos || [];
    if (opciones.length > 0) {
      console.log(`   - Primeras opciones:`);
      opciones.slice(0, 2).forEach((opcion) => {
        console.log(`     * ${opcion.label} (${opcion.value})`);
      });
    }
  } else {
    console.log(`‚ùå Error: ${resultado.error}`);
    if (resultado.detalle) {
      console.log(`   Detalle: ${resultado.detalle}`);
    }
    console.log(`   Status: ${resultado.status}`);
  }

  return resultado;
}

/**
 * Prueba opciones con b√∫squeda
 */
async function probarOpcionesConBusqueda(formulario, campo, busqueda) {
  console.log(
    `\nüîé Probando b√∫squeda en ${formulario}/${campo} con t√©rmino: "${busqueda}"`
  );

  const resultado = await hacerRequest(
    "GET",
    `/${formulario}/${campo}/opciones?busqueda=${busqueda}&limite=3`
  );

  if (resultado.exito) {
    console.log(`‚úÖ B√∫squeda completada exitosamente`);
    console.log(
      `   - Resultados encontrados: ${resultado.datos.datos?.length || 0}`
    );

    const opciones = resultado.datos.datos || [];
    opciones.forEach((opcion) => {
      console.log(`     * ${opcion.label}`);
    });
  } else {
    console.log(`‚ùå Error: ${resultado.error.mensaje || resultado.error}`);
  }

  return resultado;
}

/**
 * Prueba opciones paginadas
 */
async function probarOpcionesPaginadas(formulario, campo) {
  console.log(`\nüìÑ Probando opciones paginadas para ${formulario}/${campo}`);

  const resultado = await hacerRequest(
    "GET",
    `/${formulario}/${campo}/opciones-paginadas?pagina=1&tamanoPagina=3`
  );

  if (resultado.exito) {
    console.log(`‚úÖ Paginaci√≥n funcionando correctamente`);
    console.log(
      `   - P√°gina: ${resultado.datos.datos?.paginacion?.pagina || "N/A"}`
    );
    console.log(
      `   - Total: ${resultado.datos.datos?.paginacion?.total || "N/A"}`
    );
    console.log(
      `   - Hay m√°s: ${resultado.datos.datos?.paginacion?.hayMas ? "S√≠" : "No"}`
    );
  } else {
    console.log(`‚ùå Error: ${resultado.error.mensaje || resultado.error}`);
  }

  return resultado;
}

/**
 * Prueba b√∫squeda m√∫ltiple
 */
async function probarBusquedaMultiple(formulario, campos) {
  console.log(`\nüîçüìä Probando b√∫squeda m√∫ltiple en ${formulario}`);
  console.log(`   Campos: ${campos.join(", ")}`);

  const resultado = await hacerRequest(
    "GET",
    `/${formulario}/buscar-multiples?campos=${campos.join(",")}&limite=2`
  );

  if (resultado.exito) {
    console.log(`‚úÖ B√∫squeda m√∫ltiple completada`);
    const datos = resultado.datos.datos || {};

    Object.keys(datos).forEach((campo) => {
      const info = datos[campo];
      console.log(
        `   - ${campo}: ${info.opciones?.length || 0} opciones${
          info.error ? ` (Error: ${info.error})` : ""
        }`
      );
    });
  } else {
    console.log(`‚ùå Error: ${resultado.error.mensaje || resultado.error}`);
  }

  return resultado;
}

/**
 * Prueba validaci√≥n de valor
 */
async function probarValidacionValor(formulario, campo, valor) {
  console.log(
    `\n‚úÖ Probando validaci√≥n de valor "${valor}" en ${formulario}/${campo}`
  );

  const resultado = await hacerRequest(
    "GET",
    `/${formulario}/${campo}/validar/${valor}`
  );

  if (resultado.exito) {
    const esValido = resultado.datos.datos?.valido;
    console.log(
      `${esValido ? "‚úÖ" : "‚ùå"} Valor es ${esValido ? "v√°lido" : "inv√°lido"}`
    );

    if (esValido && resultado.datos.datos?.valor) {
      console.log(`   - Label: ${resultado.datos.datos.valor.label}`);
    }
  } else {
    console.log(`‚ùå Error: ${resultado.error.mensaje || resultado.error}`);
  }

  return resultado;
}

/**
 * Funci√≥n principal de pruebas
 */
async function ejecutarPruebas() {
  console.log("üöÄ Iniciando pruebas de APIs de Campos Anidados");
  console.log("=".repeat(50));
  console.log(`üîê Usuario autenticado: ${CREDENCIALES_ADMIN.usuario}`);
  console.log(`üåê API Base: ${API_BASE}`);
  console.log("=".repeat(50));

  let exitosas = 0;
  let fallidas = 0;

  // Probar algunos formularios y campos
  const pruebasBasicas = [
    ["INVENTARIO", "materiales"],
    ["TRAZABILIDAD", "proveedores"],
    ["RECEPCIONES_LOTES", "ubicaciones_destino"],
  ];

  for (const [formulario, campo] of pruebasBasicas) {
    // 1. Configuraci√≥n del formulario
    const configResult = await probarConfiguracionFormulario(formulario);
    configResult.exito ? exitosas++ : fallidas++;

    // 2. Opciones b√°sicas
    const opcionesResult = await probarOpcionesCampo(formulario, campo);
    opcionesResult.exito ? exitosas++ : fallidas++;

    // 3. Opciones con b√∫squeda
    const busquedaResult = await probarOpcionesConBusqueda(
      formulario,
      campo,
      "A"
    );
    busquedaResult.exito ? exitosas++ : fallidas++;

    // 4. Opciones paginadas
    const paginadasResult = await probarOpcionesPaginadas(formulario, campo);
    paginadasResult.exito ? exitosas++ : fallidas++;

    console.log("\n" + "-".repeat(30));
  }

  // Pruebas adicionales
  console.log("\nüîß Pruebas adicionales");

  // B√∫squeda m√∫ltiple
  const multipleResult = await probarBusquedaMultiple("INVENTARIO", [
    "materiales",
    "plantas",
  ]);
  multipleResult.exito ? exitosas++ : fallidas++;

  // Validaci√≥n de valores (usando valores que probablemente existan)
  const validacionResult = await probarValidacionValor(
    "INVENTARIO",
    "materiales",
    "1"
  );
  validacionResult.exito ? exitosas++ : fallidas++;

  // Resumen final
  console.log("\n" + "=".repeat(50));
  console.log("üìä RESUMEN DE PRUEBAS");
  console.log("=".repeat(50));
  console.log(`‚úÖ Pruebas exitosas: ${exitosas}`);
  console.log(`‚ùå Pruebas fallidas: ${fallidas}`);
  console.log(
    `üìà Tasa de √©xito: ${((exitosas / (exitosas + fallidas)) * 100).toFixed(
      1
    )}%`
  );

  if (fallidas === 0) {
    console.log("\nüéâ ¬°Todas las pruebas pasaron exitosamente!");
  } else {
    console.log("\n‚ö†Ô∏è  Algunas pruebas fallaron. Revisar los logs arriba.");
  }
}

/**
 * Funci√≥n para documentar APIs adicionales
 */
async function documentarAPIsAdicionales() {
  console.log("\nüìö Documentando APIs adicionales...");

  const apisAdicionales = [
    { formulario: "OPERACIONES_FRIO_DESPACHO", campo: "materiales" },
    { formulario: "STOCK_UBICACIONES", campo: "ubicaciones" },
    { formulario: "TARJAS", campo: "proveedores" },
  ];

  for (const { formulario, campo } of apisAdicionales) {
    console.log(`üìã Documentando ${formulario}/${campo}...`);

    // Configuraci√≥n
    await hacerRequest("GET", `/${formulario}/configuracion`);

    // Opciones b√°sicas
    await hacerRequest("GET", `/${formulario}/${campo}/opciones?limite=3`);

    // Con par√°metros
    await hacerRequest(
      "GET",
      `/${formulario}/${campo}/opciones?limite=5&busqueda=test`
    );

    // Validaci√≥n
    if (campo === "materiales") {
      await hacerRequest("GET", `/${formulario}/${campo}/validar/1`);
    }
  }

  console.log("‚úÖ APIs adicionales documentadas");
}

/**
 * Funci√≥n para probar configuraci√≥n espec√≠fica
 */
async function probarConfiguracionEspecifica() {
  console.log("\nüîß Probando configuraciones espec√≠ficas");

  // Probar campos especiales
  const camposEspeciales = [
    "unidades_medida",
    "certificaciones_caa",
    "condiciones_armado",
  ];

  for (const campo of camposEspeciales) {
    console.log(`\nüìã Probando campo especial: ${campo}`);
    const resultado = await hacerRequest(
      "GET",
      `/INVENTARIO/${campo}/opciones`
    );

    if (resultado.exito) {
      console.log(
        `‚úÖ Campo especial funcionando: ${
          resultado.datos.datos?.length || 0
        } opciones`
      );
    } else {
      console.log(
        `‚ùå Error en campo especial: ${
          resultado.error.mensaje || resultado.error
        }`
      );
    }
  }
}

/**
 * Funci√≥n para generar documentaci√≥n de schemas
 */
function generarDocumentacionSchemas() {
  console.log("\nüìö Generando documentaci√≥n de schemas...");

  const schemas = {};

  Object.keys(DOCUMENTACION_GENERADA.apis).forEach((clave) => {
    const api = DOCUMENTACION_GENERADA.apis[clave];

    if (api.respuestas.exitosa && api.respuestas.exitosa.estructura) {
      schemas[clave] = {
        descripcion: generarDescripcionAPI(clave),
        request: {
          metodo: api.metodo,
          endpoint: api.endpoint,
          parametros: api.parametros,
          headers: {
            Authorization: "Bearer {token}",
            "Content-Type": "application/json",
          },
        },
        response: {
          exitosa: api.respuestas.exitosa,
          error: api.respuestas.error || {
            status: 500,
            estructura: {
              tipo: "object",
              propiedades: {
                exito: { tipo: "boolean", ejemplo: false },
                mensaje: { tipo: "string", ejemplo: "Error message" },
                codigo: { tipo: "string", ejemplo: "ERROR_CODE" },
              },
            },
          },
        },
        ejemplos: generarEjemplosDeUso(clave, api),
      };
    }
  });

  DOCUMENTACION_GENERADA.schemas = schemas;
  return schemas;
}

/**
 * Funci√≥n para generar descripci√≥n de API
 */
function generarDescripcionAPI(clave) {
  const descripciones = {
    "/INVENTARIO/configuracion":
      "Obtiene la configuraci√≥n completa de campos para formularios de inventario",
    "/INVENTARIO/materiales/opciones":
      "Obtiene opciones disponibles para el campo materiales en inventario",
    "/TRAZABILIDAD/configuracion":
      "Obtiene la configuraci√≥n completa de campos para formularios de trazabilidad",
    "/TRAZABILIDAD/proveedores/opciones":
      "Obtiene opciones disponibles para el campo proveedores en trazabilidad",
    "/RECEPCIONES_LOTES/configuracion":
      "Obtiene la configuraci√≥n completa de campos para formularios de recepciones de lotes",
  };

  const endpoint = clave.split(" ")[1];
  return descripciones[endpoint] || `API para ${endpoint}`;
}

/**
 * Funci√≥n para generar ejemplos de uso
 */
function generarEjemplosDeUso(clave, api) {
  const ejemplos = [];
  const [metodo, endpoint] = clave.split(" ");

  // Ejemplo b√°sico
  ejemplos.push({
    titulo: "Uso b√°sico",
    descripcion: `Llamada b√°sica a ${endpoint}`,
    codigo: generarCodigoEjemplo(metodo, endpoint, {}),
    respuesta: api.respuestas.exitosa?.ejemplo,
  });

  // Ejemplo con par√°metros
  if (Object.keys(api.parametros).length > 0) {
    ejemplos.push({
      titulo: "Con par√°metros",
      descripcion: `Llamada a ${endpoint} con par√°metros`,
      codigo: generarCodigoEjemplo(metodo, endpoint, api.parametros),
      respuesta: api.respuestas.exitosa?.ejemplo,
    });
  }

  return ejemplos;
}

/**
 * Funci√≥n para generar c√≥digo de ejemplo
 */
function generarCodigoEjemplo(metodo, endpoint, parametros) {
  const params = Object.keys(parametros)
    .map((key) => `${key}=${parametros[key].ejemplo}`)
    .join("&");

  const url = params ? `${endpoint}?${params}` : endpoint;

  return `
// JavaScript/Axios
const respuesta = await axios({
  method: '${metodo}',
  url: '${BASE_URL}/api/campos-anidados${url}',
  headers: {
    'Authorization': 'Bearer {token}'
  }
});

// cURL
curl -X ${metodo} \\
  -H "Authorization: Bearer {token}" \\
  "${BASE_URL}/api/campos-anidados${url}"
  `.trim();
}

/**
 * Funci√≥n para generar archivo de documentaci√≥n
 */
function generarArchivoDocumentacion() {
  console.log("\nüìÑ Generando archivo de documentaci√≥n...");

  const fecha = new Date().toLocaleDateString("es-CL");
  const hora = new Date().toLocaleTimeString("es-CL");

  let markdown = `# Documentaci√≥n APIs de Campos Anidados

*Generado autom√°ticamente el ${fecha} a las ${hora}*

## Resumen

Esta documentaci√≥n describe las APIs disponibles para el sistema de campos anidados del WMS Ranco Cherries.

### Estad√≠sticas Generales

- **Total de APIs documentadas**: ${
    Object.keys(DOCUMENTACION_GENERADA.apis).length
  }
- **Total de llamadas realizadas**: ${Object.values(
    DOCUMENTACION_GENERADA.apis
  ).reduce((sum, api) => sum + api.estadisticas.totalLlamadas, 0)}
- **Tasa de √©xito general**: ${calcularTasaExitoGeneral()}%

## Autenticaci√≥n

Todas las APIs requieren autenticaci√≥n mediante Bearer Token:

\`\`\`
Authorization: Bearer {tu_token_jwt}
\`\`\`

Para obtener un token, utiliza la API de login:

\`\`\`javascript
POST /api/auth/login
{
  "usuario": "admin",
  "password": "1234567"
}
\`\`\`

## APIs Disponibles

`;

  // Documentar cada API
  Object.keys(DOCUMENTACION_GENERADA.schemas).forEach((clave) => {
    const schema = DOCUMENTACION_GENERADA.schemas[clave];
    const [metodo, endpoint] = clave.split(" ");

    markdown += `
### ${metodo} ${endpoint}

${schema.descripcion}

#### Par√°metros

`;

    if (Object.keys(schema.request.parametros).length > 0) {
      markdown += `| Par√°metro | Tipo | Descripci√≥n | Ejemplo |\n|-----------|------|-------------|----------|\n`;

      Object.keys(schema.request.parametros).forEach((param) => {
        const p = schema.request.parametros[param];
        markdown += `| ${param} | ${p.tipo} | ${p.descripcion} | ${p.ejemplo} |\n`;
      });
    } else {
      markdown += "Esta API no requiere par√°metros.\n";
    }

    markdown += `
#### Respuesta Exitosa (${schema.response.exitosa.status})

\`\`\`json
${JSON.stringify(schema.response.exitosa.ejemplo, null, 2)}
\`\`\`

#### Estructura del Schema

${generarDocumentacionSchema(schema.response.exitosa.estructura)}

#### Ejemplo de Uso

\`\`\`javascript
${schema.ejemplos[0]?.codigo || "No disponible"}
\`\`\`

---

`;
  });

  // A√±adir secci√≥n de c√≥digos de error
  markdown += `
## C√≥digos de Error Comunes

| C√≥digo | Descripci√≥n |
|--------|-------------|
| 400 | Solicitud incorrecta - Par√°metros inv√°lidos |
| 401 | No autorizado - Token inv√°lido o faltante |
| 404 | No encontrado - Recurso no existe |
| 500 | Error interno del servidor |

## Formularios Disponibles

Los siguientes formularios est√°n disponibles en el sistema:

- **INVENTARIO**: Gesti√≥n de inventario
- **TRAZABILIDAD**: Seguimiento de productos
- **RECEPCIONES_LOTES**: Recepci√≥n de lotes
- **OPERACIONES_FRIO_DESPACHO**: Operaciones de fr√≠o y despacho
- **STOCK_UBICACIONES**: Control de stock por ubicaci√≥n
- **TARJAS**: Gesti√≥n de tarjas

## Campos Comunes

Los siguientes tipos de campos est√°n disponibles en m√∫ltiples formularios:

- **materiales**: Lista de materiales del sistema
- **proveedores**: Lista de proveedores
- **ubicaciones**: Ubicaciones de almacenamiento
- **plantas**: Plantas de procesamiento

## Notas T√©cnicas

- Todas las respuestas incluyen un campo \`exito\` que indica el estado de la operaci√≥n
- Los datos principales est√°n en el campo \`datos\` de la respuesta
- La paginaci√≥n se maneja autom√°ticamente cuando hay muchos resultados
- Las b√∫squedas son case-insensitive
- Los filtros se pueden combinar para obtener resultados m√°s espec√≠ficos

---

*Documentaci√≥n generada autom√°ticamente por el sistema de pruebas*
`;

  // Guardar archivo
  const nombreArchivo = `DOCUMENTACION_CAMPOS_ANIDADOS_${
    new Date().toISOString().split("T")[0]
  }.md`;
  const rutaArchivo = `c:\\Users\\Walter Ranco\\Desktop\\WMS\\prueba-v1\\${nombreArchivo}`;

  fs.writeFileSync(rutaArchivo, markdown, "utf8");

  console.log(`‚úÖ Documentaci√≥n guardada en: ${nombreArchivo}`);
  return nombreArchivo;
}

/**
 * Funci√≥n auxiliar para calcular tasa de √©xito general
 */
function calcularTasaExitoGeneral() {
  const stats = Object.values(DOCUMENTACION_GENERADA.apis).reduce(
    (acc, api) => {
      acc.total += api.estadisticas.totalLlamadas;
      acc.exitosas += api.estadisticas.exitosas;
      return acc;
    },
    { total: 0, exitosas: 0 }
  );

  return stats.total > 0
    ? ((stats.exitosas / stats.total) * 100).toFixed(1)
    : 0;
}

/**
 * Funci√≥n para generar documentaci√≥n de schema
 */
function generarDocumentacionSchema(estructura, nivel = 0) {
  if (!estructura) return "No disponible";

  const indent = "  ".repeat(nivel);
  let doc = "";

  if (estructura.tipo === "array") {
    doc += `${indent}- **Array** de elementos:\n`;
    if (estructura.elementos) {
      doc += generarDocumentacionSchema(estructura.elementos, nivel + 1);
    }
  } else if (estructura.tipo === "object" && estructura.propiedades) {
    Object.keys(estructura.propiedades).forEach((prop) => {
      const p = estructura.propiedades[prop];
      doc += `${indent}- **${prop}** (${p.tipo})`;

      if (p.obligatorio === false) {
        doc += " *opcional*";
      }

      if (p.ejemplo !== null && p.ejemplo !== undefined) {
        doc += `: ${
          typeof p.ejemplo === "string" ? `"${p.ejemplo}"` : p.ejemplo
        }`;
      }

      doc += "\n";

      if (p.estructura) {
        doc += generarDocumentacionSchema(p.estructura, nivel + 1);
      }
    });
  } else {
    doc += `${indent}- Tipo: ${estructura.tipo}\n`;
  }

  return doc;
}

// Ejecutar pruebas
if (require.main === module) {
  // Primero autenticar, luego ejecutar pruebas y generar documentaci√≥n
  autenticarUsuario()
    .then((autenticado) => {
      if (!autenticado) {
        console.log("\n‚ùå No se pudo autenticar. Terminando pruebas.");
        process.exit(1);
      }
      return ejecutarPruebas();
    })
    .then(() => probarConfiguracionEspecifica())
    .then(() => documentarAPIsAdicionales())
    .then(() => {
      console.log("\n‚ú® Pruebas completadas");

      // Generar documentaci√≥n
      console.log("\nüìö Generando documentaci√≥n completa...");
      generarDocumentacionSchemas();
      const archivoGenerado = generarArchivoDocumentacion();

      // Mostrar resumen final
      console.log("\n" + "=".repeat(60));
      console.log("üìä RESUMEN FINAL");
      console.log("=".repeat(60));
      console.log(
        `üìã APIs documentadas: ${
          Object.keys(DOCUMENTACION_GENERADA.apis).length
        }`
      );
      console.log(`üìÑ Archivo generado: ${archivoGenerado}`);
      console.log(`üéØ Tasa de √©xito: ${calcularTasaExitoGeneral()}%`);
      console.log(
        `‚è±Ô∏è  Total de llamadas: ${Object.values(
          DOCUMENTACION_GENERADA.apis
        ).reduce((sum, api) => sum + api.estadisticas.totalLlamadas, 0)}`
      );

      process.exit(0);
    })
    .catch((error) => {
      console.error("\nüí• Error cr√≠tico:", error);
      process.exit(1);
    });
}

module.exports = {
  autenticarUsuario,
  probarConfiguracionFormulario,
  probarOpcionesCampo,
  probarOpcionesConBusqueda,
  probarOpcionesPaginadas,
  probarBusquedaMultiple,
  probarValidacionValor,
  documentarAPIsAdicionales,
  generarDocumentacionSchemas,
  generarArchivoDocumentacion,
  documentarRespuestaAPI,
  DOCUMENTACION_GENERADA,
};
